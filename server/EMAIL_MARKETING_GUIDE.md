# Как работает email-маркетинг SuperEngulfing

Кратко: подписчики, рассылки (broadcasts), цепочки (sequences), сегменты, локали и как это потестить.

---

## 1. Подписчики (Subscribers)

- **Регистрация:** форма на сайте вызывает `POST /api/subscribe` (email, first_name, source, locale).
- **Double opt-in:** подписчик создаётся со статусом «ожидает подтверждения», ему уходит письмо с ссылкой `GET /api/confirm/:token`.
- **Подтверждение:** по клику токен проверяется, статус → `active`, `confirmed_at` ставится, отправляется welcome-письмо с PDF.
- **Локаль:** у подписчика есть `locale` (am/en) — от неё зависит, какая версия текста (AM/EN) уйдёт в рассылках и цепочках.
- В админке: **Subscribers** — список, теги, фильтр по тегам/локали, импорт CSV, массовые действия (теги, отписка).

**Тест:** зарегистрировать email на сайте → проверить письмо подтверждения → перейти по ссылке → проверить welcome с PDF. В админке должен появиться подписчик со статусом active и нужной локалью.

---

## 2. Рассылки (Broadcasts)

- **Что это:** разовая рассылка одному списку (все активные или по сегменту).
- **Сегмент:**
  - **All** — все активные подписчики; опционально фильтр по локали (`segment_locale`: am / en).
  - **By tags** — только те, у кого есть хотя бы один из выбранных тегов; опционально `segment_locale`.
- **Контент:** у рассылки есть subject/body; можно задать отдельно AM/EN (`subject_am`, `body_am`, `subject_en`, `body_en`). В письме подставляется версия по `subscriber.locale`.
- **Отправка:**
  - **Сейчас:** в админке кнопка «Send» → `POST /api/broadcasts/:id/send` — сразу отправка по сегменту.
  - **В очередь:** тело `{ "use_queue": true }` → запись в `email_send_jobs`, воркер раз в минуту забирает и отправляет (удобно для больших рассылок).
  - **По расписанию:** «Schedule» → `POST /api/broadcasts/:id/schedule` (scheduled_at, timezone). Раз в минуту планировщик смотрит `broadcasts` со статусом `scheduled` и `scheduled_at <= NOW()` и запускает отправку.
- **A/B тест:** при отправке можно передать `ab_test: true` и `subject_b` — тогда 20% получают вариант B, через 24 часа по open rate выбирается победитель и остальным 80% уходит письмо с выигравшей темой.
- **Открытия/клики:** в письма подставляется трекинг; открытие и клики пишутся в `email_log` (и при необходимости в `email_opens`). В админке по рассылке видны аналитика: sent / opened / clicked.

**Тест:** создать рассылку (draft), задать сегмент «All» или по тегу, при желании AM/EN версии. Отправить себе тест («Test send»). Потом «Send» — проверить входящее и в админке счётчики sent/opened/clicked.

---

## 3. Цепочки (Sequences)

- **Что это:** серия писем по шагам с задержками (delay_days, delay_hours). Подписчик попадает в цепочку вручную (админка: «Add to sequence») или автоматически при добавлении тега, если для этого тега настроен **Sequence trigger**.
- **Шаги:** у каждой цепочки есть шаги (sequence_emails): порядок (position), тема/тело, задержка до следующего, опционально AM/EN и **conditions** (например: «отправить только если открыли предыдущее», «только если есть тег X», «если нет тега Y»).
- **Логика отправки:** раз в минуту планировщик смотрит `subscriber_sequences` где `status = 'active'`, `next_email_at <= NOW()` и последовательность активна. Для следующего шага проверяются conditions; если ок — отправляется письмо по локали подписчика, в `email_log` пишется запись типа `sequence`, ставится следующий `next_email_at` по задержке следующего шага. Когда шагов больше нет — запись в цепочке помечается `completed`.
- **Триггеры по тегу:** в админке **Sequence triggers** — «при добавлении тега X подписчику — добавить его в цепочку Y». Тогда при добавлении тега (вручную или импортом) подписчик автоматически попадает в нужную цепочку с первого шага.

**Тест:** создать цепочку (draft), добавить 2–3 шага с маленькой задержкой (0d 0h или 0d 1h). Активировать цепочку. Вручную добавить тестового подписчика в цепочку (или добавить ему тег с триггером). Подождать 1–2 минуты, проверить входящее и в админке прогресс по цепочке.

---

## 4. Планировщик (Scheduler)

Раз в минуту (и сразу после старта API) выполняются по очереди:

1. **Scheduled broadcasts** — рассылки со статусом `scheduled` и `scheduled_at <= NOW()` → запуск отправки.
2. **A/B remainder** — рассылки с A/B тестом, у которых истёк срок (24h) и выбран победитель → отправка оставшимся 80%.
3. **Sequence emails** — цепочки: выбор записей с `next_email_at <= NOW()`, проверка conditions, отправка шага, обновление `next_email_at` / completion.
4. **Job queue** — одна запись из `email_send_jobs` со статусом `pending` (например от «Send» с `use_queue: true`) → выполнение отправки рассылки, обновление статуса джоба.

Поэтому задержки в цепочках и отложенные рассылки имеют точность «около минуты».

---

## 5. Merge-теги и трекинг

- В теме и в теле писем можно использовать: `{{first_name}}`, `{{email}}`, `{{unsubscribe_url}}`, `{{locale}}` и поля из `custom_fields` (например `{{some_field}}`). Подстановка делается при отправке по данным подписчика.
- Ссылки в письме (кроме confirm/unsubscribe) оборачиваются в `GET /api/track/click/:logId?url=...` — в лог пишется клик, затем редирект на исходный URL. Открытие письма фиксируется через трекинг-пиксель/запрос по `logId`.

---

## 6. Краткий чек-лист для детального теста

1. **Подписчик:** регистрация → письмо подтверждения → клик по ссылке → welcome с PDF. В админке Subscribers — статус active, локаль верная.
2. **Тег:** создать тег, назначить подписчику. В фильтре Subscribers по тегу — он отображается.
3. **Рассылка:** создать broadcast, сегмент All (или по тегу), при желании AM/EN. Test send на свой email. Send — проверить получение, открытие, клик; в Analytics по рассылке — sent/opened/clicked.
4. **Рассылка по расписанию:** создать broadcast, Schedule на время через 2–3 минуты. Через пару минут проверить входящее и статус рассылки (sent).
5. **Цепочка:** создать sequence, 2 шага с задержкой 0d 1h. Активировать. Добавить подписчика в цепочку (или тег с триггером). Через 1–2 минуты прийти первое письмо; через час (или как задано) — второе. В админке по цепочке — прогресс/завершение.
6. **Условия шага:** у второго шага включить «Only if previous opened» — первый шаг отправить, не открывая; второй не должен уйти. Открыть первое письмо, подождать минуту — тогда второй шаг должен отправиться.
7. **Очередь:** отправить рассылку с «use queue» (если в UI есть опция) — в логах API увидеть обработку джоба; письма уходят в течение минуты после постановки в очередь.

После этого можно считать, что мейл-маркетинг проверен детально.
